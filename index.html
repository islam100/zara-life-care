<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Zara Life Care - Ambulance Booking & Driver Panel</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f0f4f8;
    margin: 0; padding: 0;
  }
  header {
    background: #004080;
    color: white;
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
  }
  header h1 {
    margin: 0;
    font-size: 1.8rem;
  }
  button {
    cursor: pointer;
    font-weight: bold;
    padding: 10px 20px;
    border-radius: 10px;
    border: none;
    background: linear-gradient(145deg, #1e90ff, #0066cc);
    box-shadow: 5px 5px 10px #004080, -5px -5px 10px #3388ff;
    color: white;
    transition: all 0.2s ease;
    user-select: none;
    margin-left: 10px;
  }
  button:hover {
    background: linear-gradient(145deg, #3ea0ff, #3388ff);
    box-shadow: 2px 2px 5px #004080, -2px -2px 5px #66b2ff;
  }
  button:active {
    box-shadow: inset 3px 3px 5px #004080, inset -3px -3px 5px #3388ff;
  }
  button:focus {
    outline: none;
  }
  main {
    max-width: 700px;
    margin: 30px auto;
    background: white;
    padding: 20px;
    border-radius: 15px;
    box-shadow: 3px 5px 15px rgba(0,0,0,0.1);
  }
  h2 {
    text-align: center;
  }
  form {
    margin-top: 15px;
  }
  input, select, textarea {
    width: 100%;
    padding: 8px 12px;
    margin: 10px 0;
    border-radius: 8px;
    border: 1px solid #ccc;
    box-sizing: border-box;
    font-size: 1rem;
  }
  textarea {
    resize: vertical;
  }
  #statusMessage {
    margin-top: 15px;
    font-weight: bold;
    color: #444;
    text-align: center;
  }
  #driverInfo, #driverPanel, #patientPanel {
    margin-top: 20px;
    background: #dff0d8;
    padding: 15px;
    border-radius: 12px;
    box-shadow: 0 0 10px #6ab04c;
  }
  #driverInfo a {
    color: #228822;
    font-weight: bold;
    text-decoration: none;
  }
  #driverInfo a:hover {
    text-decoration: underline;
  }
  #driverPanel h3, #patientPanel h3 {
    margin-top: 0;
  }
  .hidden {
    display: none;
  }
  @media (max-width: 480px) {
    header {
      flex-direction: column;
      gap: 10px;
    }
    main {
      margin: 15px;
      padding: 15px;
    }
    button {
      margin-left: 0;
      margin-top: 10px;
      width: 100%;
    }
  }
</style>
</head>
<body>

<header>
  <h1>Zara Life Care</h1>
  <div>
    <button id="loginBtn">Login with Google</button>
    <button id="logoutBtn" class="hidden">Logout</button>
  </div>
</header>

<main>
  <div id="roleSelection" class="hidden">
    <h2>Select Role</h2>
    <button id="asPatientBtn">I am Patient</button>
    <button id="asDriverBtn">I am Driver</button>
  </div>

  <!-- Patient Panel -->
  <div id="patientPanel" class="hidden">
    <button id="bookAmbBtn" style="display:block; margin: 20px auto 10px auto; width: 200px;">Book Ambulance</button>

    <form id="bookingForm" class="hidden">
      <h3>Ambulance Booking Form</h3>
      <input type="text" id="patientName" placeholder="Patient Name" required />
      <textarea id="patientAddress" placeholder="Patient Address" rows="3" required></textarea>
      <input type="text" id="destination" placeholder="Destination" required />
      <select id="ambulanceCategory" required>
        <option value="" disabled selected>Select Ambulance Category</option>
        <option value="Basic">Basic</option>
        <option value="AC">AC</option>
        <option value="ICU">ICU</option>
        <option value="ALS">ALS (Advanced Life Support)</option>
      </select>
      <input type="tel" id="whatsappNumber" placeholder="WhatsApp Number" pattern="[0-9]{10,15}" required />
      <button type="submit">Submit Booking</button>
    </form>

    <div id="statusMessage"></div>

    <div id="driverInfo" class="hidden">
      <h3>Ambulance Assigned</h3>
      <p><strong>Driver Name:</strong> <span id="driverName"></span></p>
      <p><strong>Ambulance Category:</strong> <span id="driverAmbCategory"></span></p>
      <p><strong>Ambulance Number:</strong> <span id="driverAmbNo"></span></p>
      <p><strong>Driver WhatsApp:</strong> <a href="#" target="_blank" id="driverWhatsappLink"></a></p>
    </div>
  </div>

  <!-- Driver Panel -->
  <div id="driverPanel" class="hidden">
    <h3>Driver Registration / Update</h3>
    <form id="driverForm">
      <input type="text" id="driverNameInput" placeholder="Full Name" required />
      <input type="text" id="driverAmbNoInput" placeholder="Ambulance Number" required />
      <select id="driverAmbCategoryInput" required>
        <option value="" disabled selected>Select Ambulance Category</option>
        <option value="Basic">Basic</option>
        <option value="AC">AC</option>
        <option value="ICU">ICU</option>
        <option value="ALS">ALS (Advanced Life Support)</option>
      </select>
      <input type="tel" id="driverWhatsappInput" placeholder="Driver WhatsApp Number" pattern="[0-9]{10,15}" required />
      <button type="submit">Save Driver Info</button>
    </form>

    <h3>Your Booking Notifications</h3>
    <div id="driverNotifications">
      <p>No notifications yet.</p>
    </div>
  </div>
</main>

<!-- Firebase SDKs (v8) -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCFgRQxK_W2T9S5QWZnxAd-kYV52Kzyb94",
    authDomain: "zara-life-care.firebaseapp.com",
    databaseURL: "https://zara-life-care-default-rtdb.firebaseio.com",
    projectId: "zara-life-care",
    storageBucket: "zara-life-care.appspot.com",
    messagingSenderId: "307306937129",
    appId: "1:307306937129:web:a949207fe87dd3d538"
  };
  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.database();

  // DOM elements
  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const roleSelection = document.getElementById('roleSelection');
  const asPatientBtn = document.getElementById('asPatientBtn');
  const asDriverBtn = document.getElementById('asDriverBtn');
  const patientPanel = document.getElementById('patientPanel');
  const driverPanel = document.getElementById('driverPanel');

  const bookAmbBtn = document.getElementById('bookAmbBtn');
  const bookingForm = document.getElementById('bookingForm');
  const statusMessage = document.getElementById('statusMessage');
  const driverInfoDiv = document.getElementById('driverInfo');
  const driverNameSpan = document.getElementById('driverName');
  const driverAmbCategorySpan = document.getElementById('driverAmbCategory');
  const driverAmbNoSpan = document.getElementById('driverAmbNo');
  const driverWhatsappLink = document.getElementById('driverWhatsappLink');

  const driverForm = document.getElementById('driverForm');
  const driverNameInput = document.getElementById('driverNameInput');
  const driverAmbNoInput = document.getElementById('driverAmbNoInput');
  const driverAmbCategoryInput = document.getElementById('driverAmbCategoryInput');
  const driverWhatsappInput = document.getElementById('driverWhatsappInput');
  const driverNotifications = document.getElementById('driverNotifications');

  let currentUser = null;
  let currentRole = null; // "patient" or "driver"
  let currentBookingKey = null;

  // Login with Google
  loginBtn.addEventListener('click', () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider).catch(err => alert("Login failed: "+err.message));
  });

  logoutBtn.addEventListener('click', () => {
    auth.signOut();
  });

  auth.onAuthStateChanged(user => {
    currentUser = user;
    if(user) {
      loginBtn.classList.add('hidden');
      logoutBtn.classList.remove('hidden');
      roleSelection.classList.remove('hidden');
    } else {
      loginBtn.classList.remove('hidden');
      logoutBtn.classList.add('hidden');
      roleSelection.classList.add('hidden');
      patientPanel.classList.add('hidden');
      driverPanel.classList.add('hidden');
      bookingForm.classList.add('hidden');
      driverInfoDiv.classList.add('hidden');
      statusMessage.textContent = '';
      currentRole = null;
      currentBookingKey = null;
    }
  });

  // Role selection buttons
  asPatientBtn.addEventListener('click', () => {
    currentRole = "patient";
    roleSelection.classList.add('hidden');
    patientPanel.classList.remove('hidden');
    driverPanel.classList.add('hidden');
    driverNotifications.innerHTML = "";
    driverInfoDiv.classList.add('hidden');
    statusMessage.textContent = '';
    bookingForm.classList.add('hidden');
    loadPatientBookingStatus();
  });

  asDriverBtn.addEventListener('click', () => {
    currentRole = "driver";
    roleSelection.classList.add('hidden');
    driverPanel.classList.remove('hidden');
    patientPanel.classList.add('hidden');
    statusMessage.textContent = '';
    driverInfoDiv.classList.add('hidden');
    bookingForm.classList.add('hidden');
    loadDriverInfo();
    loadDriverNotifications();
  });

  // Book ambulance button (patient)
  bookAmbBtn.addEventListener('click', () => {
    bookingForm.classList.toggle('hidden');
  });

  // Submit booking form (patient)
  bookingForm.addEventListener('submit', e => {
    e.preventDefault();
    if(!currentUser || currentRole !== "patient") return alert("Please login as patient");

    const bookingData = {
      userId: currentUser.uid,
      patientName: document.getElementById('patientName').value,
      patientAddress: document.getElementById('patientAddress').value,
      destination: document.getElementById('destination').value,
      ambulanceCategory: document.getElementById('ambulanceCategory').value,
      whatsappNumber: document.getElementById('whatsappNumber').value,
      status: "pending",
      createdAt: firebase.database.ServerValue.TIMESTAMP
    };

    // Save booking
    const newBookingRef = db.ref('bookings').push();
    newBookingRef.set(bookingData).then(() => {
      alert("Booking submitted. Waiting for acceptance.");
      bookingForm.reset();
      bookingForm.classList.add('hidden');
      currentBookingKey = newBookingRef.key;
      listenBookingStatus(currentBookingKey);
    }).catch(err => alert("Booking failed: "+err.message));
  });

  // Load patient booking status
  function loadPatientBookingStatus() {
    if(!currentUser) return;

    // Query bookings by this userId where status = pending or accepted
    db.ref('bookings').orderByChild('userId').equalTo(currentUser.uid).once('value')
      .then(snapshot => {
        let found = false;
        snapshot.forEach(childSnap => {
          const booking = childSnap.val();
          if(booking.status === 'accepted' || booking.status === 'pending') {
            found = true;
            currentBookingKey = childSnap.key;
            if(booking.status === 'accepted' && booking.driverInfo){
              statusMessage.textContent = "Your ambulance booking accepted!";
              showDriverInfo(booking.driverInfo);
            } else {
              statusMessage.textContent = "Waiting for ambulance acceptance.";
              driverInfoDiv.classList.add('hidden');
            }
            listenBookingStatus(currentBookingKey);
          }
        });
        if(!found){
          statusMessage.textContent = "No active booking found. Please book ambulance.";
          driverInfoDiv.classList.add('hidden');
          currentBookingKey = null;
        }
      });
  }

  // Listen booking status realtime
  function listenBookingStatus(bookingKey) {
    if(!bookingKey) return;
    const bookingRef = db.ref('bookings/' + bookingKey);
    bookingRef.on('value', snapshot => {
      const booking = snapshot.val();
      if(!booking) return;

      if(booking.status === 'accepted' && booking.driverInfo){
        statusMessage.textContent = "Your ambulance booking accepted!";
        showDriverInfo(booking.driverInfo);
      } else if(booking.status === 'pending'){
        statusMessage.textContent = "Waiting for ambulance acceptance.";
        driverInfoDiv.classList.add('hidden');
      }
    });
  }

  // Show driver info (patient side)
  function showDriverInfo(driverInfo) {
    if(!driverInfo){
      driverInfoDiv.classList.add('hidden');
      return;
    }
    driverNameSpan.textContent = driverInfo.driverName || 'N/A';
    driverAmbCategorySpan.textContent = driverInfo.ambulanceCategory || 'N/A';
    driverAmbNoSpan.textContent = driverInfo.ambulanceNumber || 'N/A';
    if(driverInfo.whatsappNumber){
      const waNum = driverInfo.whatsappNumber.replace(/\D/g,'');
      driverWhatsappLink.href = `https://wa.me/${waNum}`;
      driverWhatsappLink.textContent = driverInfo.whatsappNumber;
    } else {
      driverWhatsappLink.href = '#';
      driverWhatsappLink.textContent = 'N/A';
    }
    driverInfoDiv.classList.remove('hidden');
  }

  // Driver form submit (save/update driver info)
  driverForm.addEventListener('submit', e => {
    e.preventDefault();
    if(!currentUser || currentRole !== "driver") return alert("Please login as driver");

    const driverData = {
      driverName: driverNameInput.value,
      ambulanceNumber: driverAmbNoInput.value,
      ambulanceCategory: driverAmbCategoryInput.value,
      whatsappNumber: driverWhatsappInput.value,
      userId: currentUser.uid,
      createdAt: firebase.database.ServerValue.TIMESTAMP
    };

    db.ref('drivers/' + currentUser.uid).set(driverData)
      .then(() => {
        alert("Driver info saved.");
        loadDriverInfo();
      }).catch(err => alert("Error saving driver info: "+err.message));
  });

  // Load driver info into form
  function loadDriverInfo() {
    db.ref('drivers/' + currentUser.uid).once('value')
      .then(snapshot => {
        const d = snapshot.val();
        if(d){
          driverNameInput.value = d.driverName || '';
          driverAmbNoInput.value = d.ambulanceNumber || '';
          driverAmbCategoryInput.value = d.ambulanceCategory || '';
          driverWhatsappInput.value = d.whatsappNumber || '';
        } else {
          driverNameInput.value = '';
          driverAmbNoInput.value = '';
          driverAmbCategoryInput.value = '';
          driverWhatsappInput.value = '';
        }
      });
  }

  // Load driver booking notifications (bookings where status=pending and ambulanceCategory matches)
  function loadDriverNotifications() {
    driverNotifications.innerHTML = "";
    db.ref('bookings').orderByChild('status').equalTo('pending').on('value', snapshot => {
      let html = "";
      snapshot.forEach(childSnap => {
        const booking = childSnap.val();
        const bookingKey = childSnap.key;

        // Check if driver's ambulanceCategory matches booking ambulanceCategory
        db.ref('drivers/' + currentUser.uid).once('value').then(driverSnap => {
          const driver = driverSnap.val();
          if(driver && driver.ambulanceCategory === booking.ambulanceCategory){
            html += `
              <div style="border:1px solid #ccc; padding:10px; margin-bottom:10px; border-radius:8px; background:#e8f5e9;">
                <p><strong>Patient:</strong> ${booking.patientName}</p>
                <p><strong>Address:</strong> ${booking.patientAddress}</p>
                <p><strong>Destination:</strong> ${booking.destination}</p>
                <p><strong>WhatsApp:</strong> <a href="https://wa.me/${booking.whatsappNumber.replace(/\D/g,'')}" target="_blank">${booking.whatsappNumber}</a></p>
                <button onclick="acceptBooking('${bookingKey}')">Accept Booking</button>
                <button onclick="rejectBooking('${bookingKey}')">Reject Booking</button>
              </div>
            `;
            driverNotifications.innerHTML = html;
          } else if(html === "") {
            driverNotifications.innerHTML = "<p>No matching bookings available.</p>";
          }
        });
      });
    });
  }

  // Accept booking (driver)
  function acceptBooking(bookingKey) {
    if(!currentUser) return alert("Login required");

    // Get driver info
    db.ref('drivers/' + currentUser.uid).once('value').then(driverSnap => {
      const driver = driverSnap.val();
      if(!driver) return alert("Please save your driver info first.");

      // Update booking
      db.ref('bookings/' + bookingKey).update({
        status: 'accepted',
        driverInfo: driver,
        acceptedBy: currentUser.uid,
        acceptedAt: firebase.database.ServerValue.TIMESTAMP
      }).then(() => {
        alert("Booking accepted.");
      }).catch(err => alert("Failed to accept booking: "+err.message));
    });
  }

  // Reject booking (driver)
  function rejectBooking(bookingKey) {
    if(!currentUser) return alert("Login required");
    db.ref('bookings/' + bookingKey).update({
      status: 'rejected'
    }).then(() => {
      alert("Booking rejected.");
    }).catch(err => alert("Failed to reject booking: "+err.message));
  }

</script>

</body>
</html>
