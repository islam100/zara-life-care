<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Driver Registration - Zara Life Care</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin:0; padding: 20px; background: #f5f5f5;
  }
  h2 {
    text-align: center;
  }
  form, .dashboard, .waiting {
    max-width: 480px;
    margin: 0 auto 30px;
    background: white;
    padding: 20px;
    border-radius: 15px;
    box-shadow:
      0 6px 8px rgba(0,0,0,0.15),
      inset 0 -4px 0 rgba(255,255,255,0.4);
  }
  form input, form select, form button, form label {
    width: 100%;
    margin-bottom: 15px;
  }
  form input, form select {
    padding: 10px;
    font-size: 1em;
    border-radius: 10px;
    border: 1.5px solid #ccc;
    box-sizing: border-box;
  }
  form button {
    background: linear-gradient(145deg, #4caf50, #388e3c);
    color: white;
    font-weight: 700;
    font-size: 1.1em;
    padding: 14px;
    border: none;
    border-radius: 20px;
    cursor: pointer;
    box-shadow:
      0 6px 8px rgba(0,0,0,0.35),
      inset 0 -4px 0 rgba(255,255,255,0.3);
    transition: all 0.3s ease;
  }
  form button:hover {
    background: linear-gradient(145deg, #388e3c, #2e7030);
  }
  button.action-btn {
    background: linear-gradient(145deg, #2196f3, #1565c0);
    color: white;
    font-weight: 700;
    font-size: 1em;
    padding: 10px;
    margin: 5px 0;
    border: none;
    border-radius: 15px;
    cursor: pointer;
    width: 100%;
    box-shadow:
      0 6px 8px rgba(0,0,0,0.35),
      inset 0 -4px 0 rgba(255,255,255,0.3);
    transition: all 0.3s ease;
  }
  button.action-btn:hover {
    background: linear-gradient(145deg, #1565c0, #0d3a7a);
  }
  .card {
    background: #e0f7fa;
    padding: 15px;
    border-radius: 15px;
    margin-bottom: 15px;
    box-shadow:
      0 4px 6px rgba(0,0,0,0.1),
      inset 0 -2px 0 rgba(255,255,255,0.3);
  }
  .card p {
    margin: 5px 0;
  }
  .whatsapp-btn {
    background: #25d366;
    color: white;
    border: none;
    padding: 10px;
    border-radius: 12px;
    cursor: pointer;
    font-weight: 700;
    width: 100%;
    margin-top: 10px;
    box-shadow:
      0 4px 6px rgba(0,0,0,0.2),
      inset 0 -3px 0 rgba(255,255,255,0.3);
  }
  .whatsapp-btn:hover {
    background: #128c34;
  }
  #message {
    text-align: center;
    font-weight: 700;
    margin-bottom: 15px;
    color: red;
  }
  #logoutBtn {
    max-width: 480px;
    margin: 10px auto 30px;
    display: block;
    background: linear-gradient(145deg, #ff4444, #cc0000);
    color: white;
    font-weight: 700;
    font-size: 1.1em;
    padding: 12px;
    border: none;
    border-radius: 20px;
    cursor: pointer;
    box-shadow:
      0 6px 8px rgba(0,0,0,0.35),
      inset 0 -4px 0 rgba(255,255,255,0.3);
    transition: all 0.3s ease;
  }
  #logoutBtn:hover {
    background: linear-gradient(145deg, #cc0000, #990000);
  }
  @media(max-width: 520px) {
    form, .dashboard, .waiting, #logoutBtn {
      width: 95%;
      margin: 0 auto 20px;
    }
  }
</style>
</head>
<body>

<h2>Zara Life Care - Driver Registration & Dashboard</h2>

<div id="message"></div>

<!-- Driver Registration Form -->
<form id="driverForm" style="display:none" enctype="multipart/form-data">
  <input type="text" id="driverName" placeholder="Driver Name" required />
  <input type="tel" id="whatsappNumber" placeholder="WhatsApp Number (10 digits)" pattern="[0-9]{10}" required />
  <input type="text" id="ambulanceNumber" placeholder="Ambulance Number" required />
  <select id="ambulanceCategory" required>
    <option value="" disabled selected>Select Ambulance Category</option>
    <option value="ICU">ICU</option>
    <option value="Basic">Basic</option>
    <option value="Non-ICU">Non-ICU</option>
  </select>
  <input type="text" id="drivingLicenceNo" placeholder="Driving Licence Number" required />
  
  <label for="drivingLicenceUpload">Upload Driving Licence (image/pdf)</label>
  <input type="file" id="drivingLicenceUpload" accept="image/*,application/pdf" required />

  <input type="text" id="aadharNo" placeholder="Aadhar Number" required />
  <label for="aadharFrontUpload">Upload Aadhar Front (image/pdf)</label>
  <input type="file" id="aadharFrontUpload" accept="image/*,application/pdf" required />
  <label for="aadharBackUpload">Upload Aadhar Back (image/pdf)</label>
  <input type="file" id="aadharBackUpload" accept="image/*,application/pdf" required />

  <input type="text" id="panCardNo" placeholder="PAN Card Number" required />
  <label for="panCardUpload">Upload PAN Card (image/pdf)</label>
  <input type="file" id="panCardUpload" accept="image/*,application/pdf" required />

  <label for="rcBookUpload">Upload Ambulance RC Book (image/pdf)</label>
  <input type="file" id="rcBookUpload" accept="image/*,application/pdf" required />

  <button type="submit">Submit Registration</button>
</form>

<!-- Waiting for Approval Message -->
<div id="waitingApproval" class="waiting" style="display:none; text-align:center; font-weight:bold; color:#ff9800;">
  Your registration is under review. Please wait for admin approval.
</div>

<!-- Dashboard for Approved Drivers -->
<div id="dashboard" class="dashboard" style="display:none;">
  <h3>Your Bookings</h3>
  <div id="bookingsList"></div>
</div>

<button id="logoutBtn" style="display:none;">Logout</button>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

<script>
  // Firebase config (अपना डालें)
  const firebaseConfig = {
    apiKey: "AIzaSyCFgRQxK_W2T9S5QWZnxAd-kYV52Kzyb94",
    authDomain: "zara-life-care.firebaseapp.com",
    databaseURL: "https://zara-life-care-default-rtdb.firebaseio.com/",
    projectId: "zara-life-care",
    storageBucket: "zara-life-care.appspot.com",
    messagingSenderId: "307306937129",
    appId: "1:307306937129:web:a949207fe64fe87dd3d538"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  const driverForm = document.getElementById('driverForm');
  const waitingApproval = document.getElementById('waitingApproval');
  const dashboard = document.getElementById('dashboard');
  const bookingsList = document.getElementById('bookingsList');
  const messageDiv = document.getElementById('message');
  const logoutBtn = document.getElementById('logoutBtn');

  // Helper: Show messages
  function showMessage(msg, isError = false) {
    messageDiv.textContent = msg;
    messageDiv.style.color = isError ? 'red' : 'green';
  }

  // Convert file to base64 (for Imgbb upload)
  function fileToBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result.split(',')[1]);
      reader.onerror = error => reject(error);
      reader.readAsDataURL(file);
    });
  }

  // Upload image/pdf to imgbb
  async function uploadToImgbb(file) {
    const apiKey = "42cf088278c9d71875593d8259082376"; // आपकी Imgbb API key
    const base64Image = await fileToBase64(file);

    const formData = new FormData();
    formData.append("image", base64Image);

    const response = await fetch(`https://api.imgbb.com/1/upload?key=${apiKey}`, {
      method: "POST",
      body: formData
    });
    const data = await response.json();
    if (data.success) {
      return data.data.url;
    } else {
      throw new Error("Image upload failed: " + data.error.message);
    }
  }

  // Check if user already registered driver data
  async function checkDriverData(uid) {
    const snap = await db.ref('drivers/' + uid).get();
    return snap.exists() ? snap.val() : null;
  }

  // Load bookings assigned to this driver
  async function loadBookings(driverId) {
    bookingsList.innerHTML = 'Loading bookings...';
    try {
      const snapshot = await db.ref('bookings').orderByChild('driverId').equalTo(driverId).get();
      const bookings = snapshot.val();
      if (!bookings) {
        bookingsList.innerHTML = '<p>No bookings assigned yet.</p>';
        return;
      }
      bookingsList.innerHTML = '';
      for (const [key, booking] of Object.entries(bookings)) {
        bookingsList.innerHTML += createBookingCard(key, booking);
      }
      addBookingButtonsListeners(driverId);
    } catch (e) {
      bookingsList.innerHTML = '<p style="color:red;">Failed to load bookings: ' + e.message + '</p>';
    }
  }

  // Create booking card HTML
  function createBookingCard(key, booking) {
    let btns = '';
    if(booking.status === 'pending'){
      btns = `<button class="action-btn accept-btn" data-key="${key}">Accept (₹20 wallet)</button>`;
    } else if(booking.status === 'accepted' || booking.status === 'confirmed'){
      btns = `
        <button class="whatsapp-btn" data-whatsapp="${booking.patientPhone}">WhatsApp Patient</button>
        <button class="action-btn cancel-btn" data-key="${key}" style="background: #f44336; margin-top:10px;">Cancel Booking</button>
      `;
    } else if(booking.status === 'cancelled'){
      btns = `<p style="color:#f44336;">Cancelled</p>`;
    }
    return `
      <div class="card">
        <p><strong>Patient:</strong> ${booking.patientName}</p>
        <p><strong>Phone:</strong> ${booking.patientPhone}</p>
        <p><strong>Pickup:</strong> ${booking.patientAddress}</p>
        <p><strong>Destination:</strong> ${booking.destination}</p>
        <p><strong>Category:</strong> ${booking.ambulanceCategory}</p>
        <p><strong>Status:</strong> ${booking.status}</p>
        ${btns}
      </div>
    `;
  }

  // Add event listeners for Accept, Cancel, WhatsApp buttons
  function addBookingButtonsListeners(driverId) {
    // Accept booking
    document.querySelectorAll('.accept-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const bookingKey = btn.dataset.key;
        try {
          // Check wallet balance
          const driverSnap = await db.ref('drivers/' + driverId).get();
          const driverData = driverSnap.val();
          if(driverData.wallet < 20){
            alert('Insufficient wallet balance to accept booking.');
            return;
          }
          // Deduct 20 from wallet
          await db.ref('drivers/' + driverId + '/wallet').set(driverData.wallet - 20);

          // Update booking status
          await db.ref('bookings/' + bookingKey).update({
            status: 'accepted',
          });

          alert('Booking accepted. ₹20 deducted from wallet.');
          loadBookings(driverId);
        } catch(e){
          alert('Error accepting booking: ' + e.message);
        }
      });
    });

    // Cancel booking
    document.querySelectorAll('.cancel-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const bookingKey = btn.dataset.key;
        if(!confirm('Are you sure to cancel this booking?')) return;
        try {
          await db.ref('bookings/' + bookingKey).update({status: 'cancelled'});
          alert('Booking cancelled.');
          loadBookings(driverId);
        } catch(e){
          alert('Error cancelling booking: ' + e.message);
        }
      });
    });

    // WhatsApp patient
    document.querySelectorAll('.whatsapp-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const phone = btn.dataset.whatsapp;
        if(!phone){
          alert('WhatsApp number not available');
          return;
        }
        const url = `https://wa.me/91${phone}`;
        window.open(url, '_blank');
      });
    });
  }

  // Submit driver registration form
  driverForm.addEventListener('submit', async e => {
    e.preventDefault();
    showMessage('');

    const user = auth.currentUser;
    if(!user){
      alert('Please login first');
      return;
    }

    try {
      // Get files
      const drivingLicenceFile = document.getElementById('drivingLicenceUpload').files[0];
      const aadharFrontFile = document.getElementById('aadharFrontUpload').files[0];
      const aadharBackFile = document.getElementById('aadharBackUpload').files[0];
      const panCardFile = document.getElementById('panCardUpload').files[0];
      const rcBookFile = document.getElementById('rcBookUpload').files[0];

      if(!drivingLicenceFile || !aadharFrontFile || !aadharBackFile || !panCardFile || !rcBookFile){
        alert('Please upload all required documents.');
        return;
      }

      showMessage('Uploading documents, please wait...');

      // Upload files to imgbb
      const drivingLicenceURL = await uploadToImgbb(drivingLicenceFile);
      const aadharFrontURL = await uploadToImgbb(aadharFrontFile);
      const aadharBackURL = await uploadToImgbb(aadharBackFile);
      const panCardURL = await uploadToImgbb(panCardFile);
      const rcBookURL = await uploadToImgbb(rcBookFile);

      // Prepare driver data object
      const driverData = {
        driverName: document.getElementById('driverName').value.trim(),
        whatsappNumber: document.getElementById('whatsappNumber').value.trim(),
        ambulanceNumber: document.getElementById('ambulanceNumber').value.trim(),
        ambulanceCategory: document.getElementById('ambulanceCategory').value,
        drivingLicenceNo: document.getElementById('drivingLicenceNo').value.trim(),
        drivingLicenceURL,
        aadharNo: document.getElementById('aadharNo').value.trim(),
        aadharFrontURL,
        aadharBackURL,
        panCardNo: document.getElementById('panCardNo').value.trim(),
        panCardURL,
        rcBookURL,
        wallet: 0,
        isApproved: false,
        email: user.email || null,
        createdAt: Date.now()
      };

      // Save driver data in Firebase DB
      await db.ref('drivers/' + user.uid).set(driverData);

      // Notify admin on WhatsApp
      const adminWhatsApp = "917378342192";
      const adminMsg = encodeURIComponent(`New driver registration:\nName: ${driverData.driverName}\nWhatsApp: ${driverData.whatsappNumber}\nAmbulance: ${driverData.ambulanceNumber}\nPlease review and approve.`);
      window.open(`https://wa.me/${adminWhatsApp}?text=${adminMsg}`, '_blank');

      showMessage('Registration submitted successfully! Wait for admin approval.');
      driverForm.style.display = 'none';
      waitingApproval.style.display = 'block';

    } catch (error) {
      showMessage('Error: ' + error.message, true);
    }
  });

  logoutBtn.addEventListener('click', () => {
    auth.signOut();
  });

  // On auth state changed - control UI
  auth.onAuthStateChanged(async user => {
    if(user){
      logoutBtn.style.display = 'block';
      messageDiv.textContent = '';

      const driverData = await checkDriverData(user.uid);

      if(driverData){
        if(driverData.isApproved){
          driverForm.style.display = 'none';
          waitingApproval.style.display = 'none';
          dashboard.style.display = 'block';
          loadBookings(user.uid);
        } else {
          driverForm.style.display = 'none';
          waitingApproval.style.display = 'block';
          dashboard.style.display = 'none';
        }
      } else {
        driverForm.style.display = 'block';
        waitingApproval.style.display = 'none';
        dashboard.style.display = 'none';
      }
    } else {
      logoutBtn.style.display = 'none';
      driverForm.style.display = 'none';
      waitingApproval.style.display = 'none';
      dashboard.style.display = 'none';
      showMessage('Please login to continue.', true);
    }
  });
</script>

</body>
</html>
