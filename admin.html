<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin Panel - Zara Life Care</title>
<style>
  body {
    font-family: Arial, sans-serif;
    padding: 20px;
    background: #f9f9f9;
  }
  h1 { color: #333; }
  button {
    padding: 6px 12px;
    margin: 5px;
    border: none;
    background: #007BFF;
    color: white;
    cursor: pointer;
    border-radius: 5px;
  }
  button:hover {
    background: #0056b3;
  }
  table {
    border-collapse: collapse;
    width: 100%;
    margin-top: 20px;
  }
  th, td {
    padding: 10px;
    border: 1px solid #ddd;
  }
  th {
    background: #007BFF;
    color: white;
  }
</style>
</head>
<body>

<h1>Admin Panel - Zara Life Care</h1>
<button id="logoutBtn">Logout</button>

<h2>Bookings</h2>
<table id="bookingTable">
  <thead>
    <tr>
      <th>Patient Name</th>
      <th>Phone</th>
      <th>Address</th>
      <th>Destination</th>
      <th>Ambulance Category</th>
      <th>Status</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<h2>Drivers</h2>
<table id="driversTable">
  <thead>
    <tr>
      <th>Name</th>
      <th>Ambulance Number</th>
      <th>Category</th>
      <th>Whatsapp</th>
      <th>Approved</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyCFgRQxK_W2T9S5QWZnxAd-kYV52Kzyb94",
    authDomain: "zara-life-care.firebaseapp.com",
    databaseURL: "https://zara-life-care-default-rtdb.firebaseio.com/",
    projectId: "zara-life-care",
    storageBucket: "zara-life-care.appspot.com",
    messagingSenderId: "307306937129",
    appId: "1:307306937129:web:a949207fe64fe87dd3d538"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  const adminsRef = db.ref('admins');
  const bookingsRef = db.ref('bookings');
  const driversRef = db.ref('drivers');

  const bookingTableBody = document.querySelector('#bookingTable tbody');
  const driversTableBody = document.querySelector('#driversTable tbody');
  const logoutBtn = document.getElementById('logoutBtn');

  let currentUser = null;

  // Check admin permission
  function isAdmin(user) {
    return adminsRef.orderByChild('email').equalTo(user.email).once('value').then(snapshot => {
      return snapshot.exists();
    });
  }

  // Show Bookings in table
  function loadBookings() {
    bookingsRef.on('value', snapshot => {
      bookingTableBody.innerHTML = '';
      const bookings = snapshot.val();
      if (!bookings) return;

      Object.entries(bookings).forEach(([key, booking]) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${booking.patientName || ''}</td>
          <td>${booking.patientPhone || ''}</td>
          <td>${booking.patientAddress || ''}</td>
          <td>${booking.destination || ''}</td>
          <td>${booking.ambulanceCategory || ''}</td>
          <td>${booking.status || 'pending'}</td>
          <td>
            ${booking.status === 'pending' ? 
              `<button onclick="changeBookingStatus('${key}', 'confirmed')">Approve</button>
               <button onclick="changeBookingStatus('${key}', 'rejected')">Reject</button>` : ''}
          </td>
        `;
        bookingTableBody.appendChild(tr);
      });
    });
  }

  // Change booking status
  window.changeBookingStatus = function(key, status) {
    bookingsRef.child(key).update({status: status, confirmedBy: currentUser.email});
  }

  // Show Drivers in table
  function loadDrivers() {
    driversRef.on('value', snapshot => {
      driversTableBody.innerHTML = '';
      const drivers = snapshot.val();
      if (!drivers) return;

      Object.entries(drivers).forEach(([key, driver]) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${driver.driverName || ''}</td>
          <td>${driver.ambulanceNumber || ''}</td>
          <td>${driver.ambulanceCategory || ''}</td>
          <td>${driver.whatsappNumber || ''}</td>
          <td>${driver.isApproved ? 'Yes' : 'No'}</td>
          <td>
            ${driver.isApproved ? 
              `<button onclick="approveDriver('${key}', false)">Revoke</button>` : 
              `<button onclick="approveDriver('${key}', true)">Approve</button>`}
          </td>
        `;
        driversTableBody.appendChild(tr);
      });
    });
  }

  // Approve / Revoke driver
  window.approveDriver = function(key, approve) {
    driversRef.child(key).update({isApproved: approve});
  }

  logoutBtn.addEventListener('click', () => {
    auth.signOut();
  });

  // Authentication & authorization
  auth.onAuthStateChanged(async user => {
    if (user) {
      currentUser = user;
      const admin = await isAdmin(user);
      if (!admin) {
        alert('You are not authorized to access this page.');
        auth.signOut();
        location.href = 'index.html'; // या लॉगिन पेज
        return;
      }
      loadBookings();
      loadDrivers();
    } else {
      location.href = 'index.html'; // या लॉगिन पेज
    }
  });

  // Trigger Google login if not logged in
  auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(console.error);
</script>

</body>
</html>
